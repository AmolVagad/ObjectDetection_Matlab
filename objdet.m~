clc;
clear;
close all;
%% Initial pre-processing 
% Read the object image 

boxImage = imread('object.JPG');
boxImage = imrotate(boxImage,180);
boxImage = rgb2gray(boxImage);
figure;
imshow(boxImage);
title('Image of a object');

% Read the scene image 
sceneImage = imread('desk.JPG');
sceneImage = rgb2gray(sceneImage);
figure;
imshow(sceneImage);
title('Image of a Cluttered Scene');
%% Implementation of SURF based feature detection and object detection
% Detect the featrure points using SURF feature detection 
boxPoints = detectSURFFeatures(boxImage);
scenePoints = detectSURFFeatures(sceneImage);
figure;
imshow(sceneImage);


% Visualizing the strongest points in the object image 
figure;
imshow(boxImage);
title('100 Strongest Feature Points from Box Image');
hold on;
plot(selectStrongest(boxPoints, 200));


% Visualizing the strongest points in the target scene image
figure;
imshow(sceneImage);
title('300 Strongest Feature Points from Scene Image');
hold on;
plot(selectStrongest(scenePoints, 300));

% extracting feature descriptors at interest points in both images 
[boxFeatures, boxPoints] = extractFeatures(boxImage, boxPoints);
[sceneFeatures, scenePoints] = extractFeatures(sceneImage, scenePoints);

% Matching the features using the descriptors 
boxPairs = matchFeatures(boxFeatures, sceneFeatures);

% Display the matched features
matchedBoxPoints = boxPoints(boxPairs(:, 1), :);
matchedScenePoints = scenePoints(boxPairs(:, 2), :);
figure;
showMatchedFeatures(boxImage, sceneImage, matchedBoxPoints, ...
    matchedScenePoints, 'montage');
title('Putatively Matched Points (Including Outliers)');


% Locating the object in the scene 
[tform, inlierBoxPoints, inlierScenePoints] = ...
    estimateGeometricTransform(matchedBoxPoints, matchedScenePoints, 'affine');


% Displaying the matched points after removing the outliers
figure;
showMatchedFeatures(boxImage, sceneImage, inlierBoxPoints, ...
    inlierScenePoints, 'montage');
title('Matched Points (Inliers Only)');


%Drawing bounding box on the reference image 
boxPolygon = [1, 1;...                           % top-left
        size(boxImage, 2), 1;...                 % top-right
        size(boxImage, 2), size(boxImage, 1);... % bottom-right
        1, size(boxImage, 1);...                 % bottom-left
        1, 1];                   % top-left again to close the polygon

    
%Transforming polygon i9n the coordinate system of the transformed image 
newBoxPolygon = transformPointsForward(tform, boxPolygon);


% Displaying the detectd object 
figure;
imshow(sceneImage);
hold on;
line(newBoxPolygon(:, 1), newBoxPolygon(:, 2), 'Color', 'y');
title('Detected Box');


%% Implementation of BRISK based feature detection and object detection
% Detect the featrure points using SURF feature detection 
boxPointsB = detectBRISKeatures(boxImage);
scenePointsB = detectBRISKFeatures(sceneImage);
figure;
imshow(sceneImage);


% Visualizing the strongest points in the object image 
figure;
imshow(boxImage);
title('100 Strongest Feature Points from Box Image');
hold on;
plot(selectStrongest(boxPointsB, 200));


% Visualizing the strongest points in the target scene image
figure;
imshow(sceneImage);
title('300 Strongest BRISK Feature Points from Scene Image');
hold on;
plot(selectStrongest(scenePointsB, 300));

% extracting feature descriptors at interest points in both images 
[boxFeaturesB, boxPointsB] = extractFeatures(boxImage, boxPointsB);
[sceneFeaturesB, scenePointsB] = extractFeatures(sceneImage, scenePointsB);

% Matching the features using the descriptors 
boxPairsB = matchFeatures(boxFeaturesB, sceneFeaturesB);

% Display the matched features
matchedBoxPointsB = boxPointsB(boxPairsB(:, 1), :);
matchedScenePointsB = scenePointsB(boxPairsB(:, 2), :);
figure;
showMatchedFeatures(boxImage, sceneImage, matchedBoxPointsB, ...
    matchedScenePointsB, 'montage');
title('Putatively Matched Points (Including Outliers) using BRISK');


% Locating the object in the scene 
[tformB, inlierBoxPointsB, inlierScenePointsB] = ...
    estimateGeometricTransform(matchedBoxPointsB, matchedScenePointsB, 'affine');


% Displaying the matched points after removing the outliers
figure;
showMatchedFeatures(boxImage, sceneImage, inlierBoxPointsB, ...
    inlierScenePointsB, 'montage');
title('Matched Points (Inliers Only) using BRISK');


%Drawing bounding box on the reference image 
boxPolygonB = [1, 1;...                           % top-left
        size(boxImage, 2), 1;...                 % top-right
        size(boxImage, 2), size(boxImage, 1);... % bottom-right
        1, size(boxImage, 1);...                 % bottom-left
        1, 1];                   % top-left again to close the polygon

    
%Transforming polygon i9n the coordinate system of the transformed image 
newBoxPolygonB = transformPointsForward(tformB, boxPolygonB);


% Displaying the detectd object 
figure;
imshow(sceneImage);
hold on;
line(newBoxPolygonB(:, 1), newBoxPolygonB(:, 2), 'Color', 'y');
title('Detected Box using BRISK ');








